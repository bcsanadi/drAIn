<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>drAIn - Deplete</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="stylesheet" href="static/css/wave.css">
  <style>
    .msg.system .bubble {
      background: linear-gradient(45deg, #ff6b6b, #ffa726);
      color: white;
      font-size: 0.8rem;
      text-align: center;
      border-radius: 15px;
      padding: 0.5rem;
      margin: 0.3rem auto;
      max-width: 80%;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body>
  <!-- Navigation bar -->
  <nav class="nav-bar">
    <div class="nav-container">
      <a href="/home" class="logo-text">drAIn</a>
      <div class="nav-buttons">
        <a href="/deplete" class="deplete-button">Deplete</a>
        <a href="/refill" class="nav-button1">Refill</a>
        <a href="/progress" class="nav-button2">Progress</a>
        <a href="/logout" class="nav-button2">Logout</a>
      </div>
    </div>    </nav>

  <!-- Shared ocean waves - appears on all pages in the same position -->
  <div class="home-waves">
    <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
      viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="home-gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
      </defs>
      <g class="parallax">
        <use xlink:href="#home-gentle-wave" x="48" y="0" fill="rgba(0,60,120,0.95)" />
        <use xlink:href="#home-gentle-wave" x="48" y="3" fill="rgba(0,100,180,0.7)" />
        <use xlink:href="#home-gentle-wave" x="48" y="5" fill="rgba(0,140,220,0.5)" />
        <use xlink:href="#home-gentle-wave" x="48" y="7" fill="rgba(255,255,255,0.3)" />
      </g>
    </svg>
    <div class="ocean-layers"></div>
  </div>

  <!-- Chatbot content -->
  <main style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2rem; position: relative;">
    <!-- Water depletion notice -->
    <div class="depletion-notice">
      <h4>AI Water Usage</h4>
      <p>Each conversation with the AI depletes water from your virtual reservoir<br><strong>~519mL per 100 words processed (roughly one bottle of water)</strong></p>
    </div>
    
    <section class="chat-card" aria-label="AI Chatbot">
      <div class="chat-header">drAIn Chatbot</div>

      <div id="chatlog" class="chat-log">
        <div class="msg bot"><div class="bubble">Hi! How can I help you today?</div></div>
      </div>

      <form id="chat-form" class="chat-form" autocomplete="off">
        <input id="chat-input" class="chat-input" type="text" placeholder="Type your message..." required />
        <button id="chat-send" class="chat-send" type="submit">Send</button>
      </form>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <div class="footer-content">
      <p>Created with ðŸ©µ by Scrumpty Dumpty</p>
    </div>
  </footer>


  <script>
  (() => {
    const API = "http://127.0.0.1:5003/chat"; // local Flask endpoint
    const TRACKING_API = "/api/track-chatbot"; // local tracking endpoint
    const log = document.getElementById("chatlog");
    const form = document.getElementById("chat-form");
    const input = document.getElementById("chat-input");
    const sendBtn = document.getElementById("chat-send");

    const history = [];

    function addMessage(who, text) {
      const wrap = document.createElement("div");
      wrap.className = `msg ${who}`;
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;
      wrap.appendChild(bubble);
      log.appendChild(wrap);
      log.scrollTop = log.scrollHeight;
    }

    function showWaterDepletion(data) {
      // Water depletion message removed for cleaner chat experience
      // The tracking still happens in the background
    }

    async function trackChatbotInteraction(userMessage, botResponse) {
      try {
        const response = await fetch(TRACKING_API, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            user_message: userMessage, 
            bot_response: botResponse 
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.status === 'success') {
            addWaterDepletionNotice(data);
          }
        }
      } catch (err) {
        console.error('Error tracking chatbot interaction:', err);
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      addMessage("user", text);
      input.value = "";
      sendBtn.disabled = true;

      try {
        const res = await fetch(API, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text, messages: history })
        });
        const data = await res.json();
        const reply = data.reply || "(no response)";
        addMessage("bot", reply);

        // Track the interaction for water depletion
        await trackChatbotInteraction(text, reply);

        history.push({ role: "user", content: text });
        history.push({ role: "assistant", content: reply });
        if (history.length > 10) history.splice(0, history.length - 10);
      } catch (err) {
        addMessage("bot", "Oopsâ€”network error. Make sure your Python server is running!");
      } finally {
        sendBtn.disabled = false;
      }
    });
  })();
  </script>
</body>
</html>


